import { siteConfigs } from '@/configs/site.configs'
import { LPE } from '@/types/lpe.types'
import { ImageResponse } from '@vercel/og'
import { NextRequest } from 'next/server'

export const config = {
  runtime: 'edge',
}

// Doc: https://vercel.com/docs/concepts/functions/edge-functions/og-image-generation/og-image-examples#using-a-local-image
// Font: https://vercel.com/docs/functions/edge-functions/og-image-generation/og-image-examples#using-a-custom-font
export default async function handler(request: NextRequest) {
  const lora = await fetch(
    new URL('../../../assets/Lora-Regular.ttf', import.meta.url),
  ).then((res) => res.arrayBuffer())

  const inter = await fetch(
    new URL('../../../assets/Inter-Regular.ttf', import.meta.url),
  ).then((res) => res.arrayBuffer())

  const rawQ = request.nextUrl.searchParams.get('q') || ''
  const safeDecode = (v: string) => {
    try {
      return decodeURIComponent(v)
    } catch {
      return v
    }
  }
  const searchParams = new URLSearchParams(safeDecode(rawQ))
  const contentType = searchParams.get('contentType')
  const title =
    contentType == null
      ? siteConfigs.heroTitle.join('')
      : searchParams.get('title')
  const image = searchParams.get('image') || ''
  const alt = searchParams.get('alt') || ''
  const pagePath = searchParams.get('pagePath') || 'press.logos.co'
  const date = searchParams.get('date')
  const authors = searchParams.get('authors')

  const imgSrc = image
  const hasImage = !!imgSrc?.length

  const day = date && new Date(date).getUTCDate()
  const month =
    date && new Date(date).toLocaleString('default', { month: 'short' })
  const year = date && new Date(date).getUTCFullYear()

  const titleMaxLength = 66

  const isArticle = contentType === 'article'
  const titleFontSize = isArticle && hasImage ? '48px' : '64px'
  const subtitleFontSize = isArticle && hasImage ? '26px' : '32px'
  const subtitleGap = isArticle && hasImage ? '16px' : '24px'
  const subtitleMargin = isArticle && hasImage ? '24px' : '40px'

  return new ImageResponse(
    // Article with image: use full-bleed image background and overlay text
    isArticle && hasImage ? (
      <div
        style={{
          display: 'flex',
          width: '100%',
          height: '100%',
          position: 'relative',
          color: '#fff',
          backgroundColor: '#000',
        }}
      >
        <img
          src={imgSrc}
          alt={alt}
          width={1200}
          height={630}
          style={{
            position: 'absolute',
            inset: 0,
            width: '100%',
            height: '100%',
            objectFit: 'cover',
          }}
        />
        <div
          style={{
            position: 'absolute',
            inset: 0,
            background:
              'linear-gradient(180deg, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.35) 40%, rgba(0,0,0,0.55) 100%)',
          }}
        />
        <div
          style={{
            position: 'relative',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'space-between',
            width: '100%',
            height: '100%',
            padding: '56px 48px',
          }}
        >
          <div
            style={{
              gap: '0',
              display: 'flex',
              alignItems: 'center',
            }}
          >
            <svg
              width="30"
              height="40"
              viewBox="0 0 93 126"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              style={{ marginRight: '10px' }}
            >
              <path
                d="M71.2154 126C66.7864 126 62.9754 124.958 59.7824 122.873C56.5894 120.789 54.1688 117.506 52.5208 113.025C51.4908 110.002 50.7698 106.303 50.3578 101.926C49.9458 97.5484 49.6883 92.9628 49.5853 88.1687C49.4823 83.2705 49.3793 78.5285 49.2763 73.9429C49.2763 72.6923 48.9673 72.067 48.3493 72.067C47.8343 72.067 47.3193 72.4839 46.8043 73.3176C44.8473 76.9653 42.5298 81.134 39.8518 85.8238C37.2768 90.5136 34.7018 95.2035 32.1268 99.8933C29.5517 104.583 27.2342 108.804 25.1742 112.556C23.2172 116.203 21.8267 118.861 21.0027 120.529C19.9727 122.821 18.3247 124.28 16.0587 124.906C13.8957 125.635 11.1662 125.792 7.87017 125.375C4.57415 124.958 2.25664 123.655 0.91764 121.466C-0.524366 119.174 -0.266865 116.777 1.69014 114.275C3.02915 112.608 4.93466 110.107 7.40666 106.772C9.87867 103.333 12.6597 99.4764 15.7497 95.2035C18.8397 90.8263 21.9812 86.3449 25.1742 81.7593C28.4702 77.0695 31.5603 72.5881 34.4443 68.3151C37.3283 63.938 39.7488 60.134 41.7058 56.9032C43.7658 53.5682 45.1048 51.1191 45.7228 49.5558C46.3408 48.0968 47.0103 46.4814 47.7313 44.7097C48.4523 42.938 48.8128 41.1141 48.8128 39.2382C48.8128 32.3598 48.1433 27.201 46.8043 23.7618C45.5683 20.2184 43.8688 17.8734 41.7058 16.727C39.6458 15.4764 37.3798 14.8511 34.9078 14.8511C33.0538 14.8511 31.0453 15.2159 28.8822 15.9454C26.8222 16.6749 25.4832 17.3524 24.8652 17.9777C23.7322 19.1241 22.6507 19.3325 21.6207 18.603C20.5907 17.8734 20.2817 16.6749 20.6937 15.0074C21.8267 11.1514 23.8867 7.71216 26.8737 4.68982C29.8608 1.56327 34.0323 0 39.3883 0C45.0533 0 49.5338 1.61539 52.8298 4.84616C56.1259 8.07692 58.4949 13.2357 59.9369 20.3226C61.3789 27.4094 62.0999 36.7891 62.0999 48.4615C62.0999 62.2184 62.3059 73.2134 62.7179 81.4466C63.1299 89.6799 63.7994 95.8809 64.7264 100.05C65.6534 104.114 66.9409 106.824 68.5889 108.179C70.3399 109.534 72.5029 110.211 75.0779 110.211C77.5499 110.211 79.8674 109.69 82.0305 108.648C84.2965 107.605 86.2535 106.251 87.9015 104.583C88.6225 103.749 89.4465 103.437 90.3735 103.645C91.3005 103.854 92.0215 104.427 92.5365 105.365C93.1545 106.199 93.1545 107.293 92.5365 108.648C90.3735 113.442 87.4895 117.558 83.8845 120.998C80.3824 124.333 76.1594 126 71.2154 126Z"
                fill="#fff"
              />
            </svg>
            <div
              style={{
                display: 'flex',
                fontFamily: 'Lora',
                fontSize: '26px',
                whiteSpace: 'pre-wrap',
                textTransform: 'uppercase',
                paddingLeft: '3px',
              }}
            >
              <span>{siteConfigs.title}</span>
            </div>
          </div>
          <div
            style={{
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-end',
              gap: subtitleMargin,
            }}
          >
            <div
              style={{
                display: 'flex',
                fontFamily: 'Lora',
                fontSize: titleFontSize,
                lineHeight: '115%',
                whiteSpace: 'pre-wrap',
              }}
            >
              {title && title.length < titleMaxLength
                ? title
                : title?.substring(0, titleMaxLength) + '...'}
            </div>
            <div
              style={{
                display: 'flex',
                gap: subtitleGap,
                fontSize: subtitleFontSize,
                alignItems: 'center',
                textTransform: 'capitalize',
                fontFamily: 'Inter',
              }}
            >
              <span>
                {authors
                  ? `By ${authors}`
                  : pagePath.replace(/^\/+/, '').replace(/\/+/, ' | ')}
              </span>
              {date && <span>∙</span>}
              {date && <span>{`${day} ${month} ${year}`}</span>}
            </div>
          </div>
        </div>
      </div>
    ) : contentType === LPE.PostTypes.Podcast ? (
      <img
        src={imgSrc}
        alt={alt}
        width={1200}
        height={630}
        style={{
          objectFit: 'contain',
          backgroundColor: '#000',
        }}
      />
    ) : (
      <div
        style={{
          display: 'flex',
          width: '100%',
          height: '100%',
          alignItems: 'center',
          justifyContent: 'flex-start',
          backgroundColor: '#000',
          color: '#fff',
          position: 'relative',
        }}
      >
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            width: hasImage ? '600px' : '100%',
            padding: '56px 48px',
            justifyContent: 'space-between',
            height: '100%',
            position: 'relative',
          }}
        >
          <div
            style={{
              gap: '0',
              display: 'flex',
              alignItems: 'center',
            }}
          >
            {isArticle ? (
              <svg
                width="30"
                height="40"
                viewBox="0 0 93 126"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                style={{
                  marginRight: '10px',
                }}
              >
                <path
                  d="M71.2154 126C66.7864 126 62.9754 124.958 59.7824 122.873C56.5894 120.789 54.1688 117.506 52.5208 113.025C51.4908 110.002 50.7698 106.303 50.3578 101.926C49.9458 97.5484 49.6883 92.9628 49.5853 88.1687C49.4823 83.2705 49.3793 78.5285 49.2763 73.9429C49.2763 72.6923 48.9673 72.067 48.3493 72.067C47.8343 72.067 47.3193 72.4839 46.8043 73.3176C44.8473 76.9653 42.5298 81.134 39.8518 85.8238C37.2768 90.5136 34.7018 95.2035 32.1268 99.8933C29.5517 104.583 27.2342 108.804 25.1742 112.556C23.2172 116.203 21.8267 118.861 21.0027 120.529C19.9727 122.821 18.3247 124.28 16.0587 124.906C13.8957 125.635 11.1662 125.792 7.87017 125.375C4.57415 124.958 2.25664 123.655 0.91764 121.466C-0.524366 119.174 -0.266865 116.777 1.69014 114.275C3.02915 112.608 4.93466 110.107 7.40666 106.772C9.87867 103.333 12.6597 99.4764 15.7497 95.2035C18.8397 90.8263 21.9812 86.3449 25.1742 81.7593C28.4702 77.0695 31.5603 72.5881 34.4443 68.3151C37.3283 63.938 39.7488 60.134 41.7058 56.9032C43.7658 53.5682 45.1048 51.1191 45.7228 49.5558C46.3408 48.0968 47.0103 46.4814 47.7313 44.7097C48.4523 42.938 48.8128 41.1141 48.8128 39.2382C48.8128 32.3598 48.1433 27.201 46.8043 23.7618C45.5683 20.2184 43.8688 17.8734 41.7058 16.727C39.6458 15.4764 37.3798 14.8511 34.9078 14.8511C33.0538 14.8511 31.0453 15.2159 28.8822 15.9454C26.8222 16.6749 25.4832 17.3524 24.8652 17.9777C23.7322 19.1241 22.6507 19.3325 21.6207 18.603C20.5907 17.8734 20.2817 16.6749 20.6937 15.0074C21.8267 11.1514 23.8867 7.71216 26.8737 4.68982C29.8608 1.56327 34.0323 0 39.3883 0C45.0533 0 49.5338 1.61539 52.8298 4.84616C56.1259 8.07692 58.4949 13.2357 59.9369 20.3226C61.3789 27.4094 62.0999 36.7891 62.0999 48.4615C62.0999 62.2184 62.3059 73.2134 62.7179 81.4466C63.1299 89.6799 63.7994 95.8809 64.7264 100.05C65.6534 104.114 66.9409 106.824 68.5889 108.179C70.3399 109.534 72.5029 110.211 75.0779 110.211C77.5499 110.211 79.8674 109.69 82.0305 108.648C84.2965 107.605 86.2535 106.251 87.9015 104.583C88.6225 103.749 89.4465 103.437 90.3735 103.645C91.3005 103.854 92.0215 104.427 92.5365 105.365C93.1545 106.199 93.1545 107.293 92.5365 108.648C90.3735 113.442 87.4895 117.558 83.8845 120.998C80.3824 124.333 76.1594 126 71.2154 126Z"
                  fill="#fff"
                />
              </svg>
            ) : (
              <svg
                width="30"
                height="40"
                viewBox="0 0 93 126"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                style={{
                  marginRight: '10px',
                }}
              >
                <path
                  d="M71.2154 126C66.7864 126 62.9754 124.958 59.7824 122.873C56.5894 120.789 54.1688 117.506 52.5208 113.025C51.4908 110.002 50.7698 106.303 50.3578 101.926C49.9458 97.5484 49.6883 92.9628 49.5853 88.1687C49.4823 83.2705 49.3793 78.5285 49.2763 73.9429C49.2763 72.6923 48.9673 72.067 48.3493 72.067C47.8343 72.067 47.3193 72.4839 46.8043 73.3176C44.8473 76.9653 42.5298 81.134 39.8518 85.8238C37.2768 90.5136 34.7018 95.2035 32.1268 99.8933C29.5517 104.583 27.2342 108.804 25.1742 112.556C23.2172 116.203 21.8267 118.861 21.0027 120.529C19.9727 122.821 18.3247 124.28 16.0587 124.906C13.8957 125.635 11.1662 125.792 7.87017 125.375C4.57415 124.958 2.25664 123.655 0.91764 121.466C-0.524366 119.174 -0.266865 116.777 1.69014 114.275C3.02915 112.608 4.93466 110.107 7.40666 106.772C9.87867 103.333 12.6597 99.4764 15.7497 95.2035C18.8397 90.8263 21.9812 86.3449 25.1742 81.7593C28.4702 77.0695 31.5603 72.5881 34.4443 68.3151C37.3283 63.938 39.7488 60.134 41.7058 56.9032C43.7658 53.5682 45.1048 51.1191 45.7228 49.5558C46.3408 48.0968 47.0103 46.4814 47.7313 44.7097C48.4523 42.938 48.8128 41.1141 48.8128 39.2382C48.8128 32.3598 48.1433 27.201 46.8043 23.7618C45.5683 20.2184 43.8688 17.8734 41.7058 16.727C39.6458 15.4764 37.3798 14.8511 34.9078 14.8511C33.0538 14.8511 31.0453 15.2159 28.8822 15.9454C26.8222 16.6749 25.4832 17.3524 24.8652 17.9777C23.7322 19.1241 22.6507 19.3325 21.6207 18.603C20.5907 17.8734 20.2817 16.6749 20.6937 15.0074C21.8267 11.1514 23.8867 7.71216 26.8737 4.68982C29.8608 1.56327 34.0323 0 39.3883 0C45.0533 0 49.5338 1.61539 52.8298 4.84616C56.1259 8.07692 58.4949 13.2357 59.9369 20.3226C61.3789 27.4094 62.0999 36.7891 62.0999 48.4615C62.0999 62.2184 62.3059 73.2134 62.7179 81.4466C63.1299 89.6799 63.7994 95.8809 64.7264 100.05C65.6534 104.114 66.9409 106.824 68.5889 108.179C70.3399 109.534 72.5029 110.211 75.0779 110.211C77.5499 110.211 79.8674 109.69 82.0305 108.648C84.2965 107.605 86.2535 106.251 87.9015 104.583C88.6225 103.749 89.4465 103.437 90.3735 103.645C91.3005 103.854 92.0215 104.427 92.5365 105.365C93.1545 106.199 93.1545 107.293 92.5365 108.648C90.3735 113.442 87.4895 117.558 83.8845 120.998C80.3824 124.333 76.1594 126 71.2154 126Z"
                  fill="#fff"
                />
              </svg>
            )}
            {contentType === 'article' && (
              <div
                style={{
                  display: 'flex',
                  fontFamily: 'Lora',
                  fontSize: '26px',
                  whiteSpace: 'pre-wrap',
                  textTransform: 'uppercase',
                  paddingLeft: '3px',
                }}
              >
                <span>{siteConfigs.title}</span>
              </div>
            )}
          </div>
          <div
            style={{
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'flex-end',
              gap: subtitleMargin,
            }}
          >
            <div
              style={{
                display: 'flex',
                fontFamily: 'Lora',
                fontSize: titleFontSize,
                lineHeight: '115%',
                whiteSpace: 'pre-wrap',
              }}
            >
              {title && title.length < titleMaxLength
                ? title
                : title?.substring(0, titleMaxLength) + '...'}
            </div>
            <div
              style={{
                display: 'flex',
                gap: subtitleGap,
                fontSize: subtitleFontSize,
                alignItems: 'center',
                textTransform: 'capitalize',
                fontFamily: 'Inter',
              }}
            >
              <span>
                {contentType === 'article' && authors
                  ? `By ${authors}`
                  : contentType ??
                    pagePath.replace(/^\/+/, '').replace(/\/+/, ' | ')}
              </span>
              {date && <span>∙</span>}
              {date && <span>{`${day} ${month} ${year}`}</span>}
            </div>
          </div>
        </div>
        {imgSrc && (
          <div style={{ display: 'flex', width: '600px', height: '630px' }}>
            <img
              src={imgSrc}
              alt={alt}
              style={{
                filter: 'grayscale(100%)',
                objectFit: 'cover',
                width: '100%',
                height: '100%',
              }}
            />
          </div>
        )}
      </div>
    ),
    {
      width: 1200,
      height: 630,
      fonts: [
        {
          name: 'Lora',
          data: lora,
          style: 'normal',
        },
        {
          name: 'Inter',
          data: inter,
          style: 'normal',
        },
      ],
    },
  )
}
